name: Update

on:
  push:
    paths: 
      - .github/workflows/update.yaml
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
      - name: Installing jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Generating app matrix
        id: set-matrix
        run: |
          # 查找所有有效的应用清单
          apps=()
          for dir in manifests/*/; do
            app_id=$(basename "$dir")
            yaml_file="manifests/$app_id/$app_id.yaml"
            if [ -f "$yaml_file" ]; then
              apps+=("$app_id")
            fi
          done
          
          echo "找到 ${#apps[@]} 个应用: ${apps[*]}"
          
          # 使用 jq 正确生成 JSON
          matrix_json=$(printf '%s\n' "${apps[@]}" | jq -R -n -c '[inputs] | {appid: .}')
          echo "生成的矩阵: $matrix_json"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT

  check-update:
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker://ghcr.io/flathub/flatpak-external-data-checker:latest
        env:
          GIT_AUTHOR_NAME: Flatpak External Data Checker
          GIT_COMMITTER_NAME: Flatpak External Data Checker
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --update --never-fork manifests/${{ matrix.appid }}/${{ matrix.appid }}.yaml
